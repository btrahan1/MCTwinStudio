@page "/map"
@inject IJSRuntime JS
@inject IDataService _dataService
@inject StateService _stateService
@inject NavigationManager Navigation
@using System.Text.Json.Nodes

<PageTitle>3D Map</PageTitle>

<!-- Style Override for Full Screen Map -->
<div class="d-flex flex-column" style="height: calc(100vh - 4.6rem); margin-top: -1.1rem; margin-left: -2rem; margin-right: -1.5rem; width: calc(100% + 3.5rem);">
    <!-- ... (UI Same as before) ... -->
    <div class="d-flex justify-content-between align-items-center p-2 bg-dark text-white">
        <h4 class="m-0">Global Operations Map</h4>
        <div class="d-flex gap-2 align-items-center">
            <span class="text-info fs-6">Click a pylon to drill down</span>
            <span class="badge bg-primary">Live Connection</span>
        </div>
    </div>
    
@inject ISchemaService _schemaService
@using UniversalTwin.Client.Components

<!-- ... (Previous UI) ... -->

    <div style="flex-grow: 1; position: relative;">
        <!-- Canvas fills the remaining space -->
        <canvas id="renderCanvas" style="width: 100%; height: 100%; touch-action: none;"></canvas>
        
        <!-- Overlay Controls -->
        <div style="position: absolute; top: 10px; left: 10px; display: flex; gap: 10px;">
            <div class="btn-group shadow">
                <button class="btn btn-sm @GetBtnClass("all")" @onclick='() => SetFilter("all")'>All</button>
                <button class="btn btn-sm @GetBtnClass("recycler")" @onclick='() => SetFilter("recycler")'>Recycler</button>
                <button class="btn btn-sm @GetBtnClass("factory")" @onclick='() => SetFilter("factory")'>Factory</button>
                <button class="btn btn-sm @GetBtnClass("retail")" @onclick='() => SetFilter("retail")'>Retail</button>
            </div>
            
            <button class="btn btn-sm btn-light shadow" @onclick="LoadPylons">
                <span class="bi bi-geo-alt-fill"></span> Refresh
            </button>
        </div>

        @if (SelectedItems != null && SelectedDefinition != null)
        {
            <!-- Holographic Glassmorphism Style -->
            <!-- Position: Offset to the Right (Top 100px, Right 50px). Transform removed. ID added for JS. -->
            <div id="holoPopup" class="holo-popup" style="position: absolute; top: 100px; right: 50px; width: 600px; max-height: 80%; overflow-y: auto; backdrop-filter: blur(12px); background-color: rgba(0, 20, 40, 0.85); border: 1px solid rgba(0, 255, 255, 0.3); box-shadow: 0 0 30px rgba(0, 255, 255, 0.2); color: white; border-radius: 8px;">
                <div class="d-flex justify-content-between align-items-center p-3 border-bottom border-secondary">
                    <h5 class="m-0 text-info" style="font-family: monospace; letter-spacing: 1px;">// SECTOR DATA</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="ClosePopup"></button>
                </div>
                <div class="p-3">
                    <!-- Directly Render GenericCard to avoid Grid constraints -->
                    @if (SelectedItems![0] is JsonObject obj)
                    {
                        <GenericCard Definition="@SelectedDefinition" Item="@obj" />
                    }
                </div>
            </div>
            
            <style>
                /* Force Transparent Backgrounds for inner cards */
                .holo-popup .card { background-color: transparent !important; border: none !important; color: white !important; }
                .holo-popup .card-header { background-color: rgba(0, 255, 255, 0.1) !important; border-bottom: 1px solid rgba(0, 255, 255, 0.3) !important; color: #0dcaf0 !important; }
                .holo-popup .card-body { background-color: transparent !important; padding: 0 !important; }
                
                /* Override CompactList Bootstrap Utilities */
                .holo-popup .bg-white { background-color: transparent !important; border: none !important; }
                .holo-popup .bg-light { background-color: rgba(0, 255, 255, 0.05) !important; border: 1px solid rgba(0, 255, 255, 0.2) !important; }
                .holo-popup .text-dark { color: #e0f7fa !important; text-shadow: 0 0 5px rgba(0, 255, 255, 0.5); }
                .holo-popup .text-muted { color: rgba(255, 255, 255, 0.7) !important; }
                .holo-popup .shadow-sm { box-shadow: none !important; }

                /* Override Input/Progress styles for Dark Mode feel */
                .holo-popup .progress { background-color: rgba(255,255,255,0.1) !important; }
                .holo-popup .form-control, .holo-popup .list-group-item { background-color: rgba(0,0,0,0.5) !important; color: white !important; border-color: #333 !important; }
            </style>
        }
    </div>
</div>

@code {
    private DotNetObjectReference<Map3D>? _objRef;
    private string ActiveFilter = "recycler"; 

    protected override void OnInitialized()
    {
        // Init filter from Shared State
        ActiveFilter = _stateService.CurrentIndustry;
    } 

    // Data Store
    private List<JsonObject>? RecyclerData;
    private List<JsonObject>? RetailData;
    private List<JsonObject>? FactoryData;

    // Selection State
    private JsonArray? SelectedItems;
    private EntityDefinition? SelectedDefinition;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _objRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("universalMap.setupClick", _objRef);
            await JS.InvokeVoidAsync("universalMap.init", "renderCanvas");
            await LoadPylons();
        }

        // Enable Dragging if Popup is visible
        if (SelectedItems != null)
        {
            await JS.InvokeVoidAsync("universalMap.makeDraggable", "holoPopup");
        }
    }

    private async Task SetFilter(string filter)
    {
        ActiveFilter = filter;
        await LoadPylons();
    }

    private string GetBtnClass(string filter) => ActiveFilter == filter ? "btn-primary" : "btn-light";

    private async Task LoadPylons()
    {
        var allLocations = new List<object>();

        // 1. Fetch & Store Recycler Data
        if (ActiveFilter == "all" || ActiveFilter == "recycler")
        {
            RecyclerData = await _dataService.GetDataAsync("recycler");
            if (RecyclerData != null) allLocations.AddRange(MapLocations(RecyclerData, "recycler"));
        }

        // 2. Fetch & Store Retail Data
        if (ActiveFilter == "all" || ActiveFilter == "retail")
        {
            RetailData = await _dataService.GetDataAsync("retail");
            if (RetailData != null) allLocations.AddRange(MapLocations(RetailData, "retail"));
        }

        // 3. Fetch & Store Factory Data
        if (ActiveFilter == "all" || ActiveFilter == "factory")
        {
            FactoryData = await _dataService.GetDataAsync("factory");
            if (FactoryData != null) allLocations.AddRange(MapLocations(FactoryData, "factory"));
        }

        await JS.InvokeVoidAsync("universalMap.renderPylons", allLocations);
    }
    
    private IEnumerable<object> MapLocations(List<JsonObject> data, string industry)
    {
        return data.Select(d => new 
        {
            latitude = (double?)d["Latitude"],
            longitude = (double?)d["Longitude"],
            name = d["Name"]?.ToString(),
            industry = industry,
            color = GetStatusColor(d["Status"]?.ToString() ?? "", industry)
        })
        .Where(l => l.latitude.HasValue && l.longitude.HasValue);
    }

    private string GetStatusColor(string status, string industry)
    {
        return status switch
        {
            "Green" => "#28a745", 
            "Yellow" => "#ffc107", 
            "Red" => "#dc3545", 
            "Running" => "#28a745",
            "Halted" => "#dc3545",
            "Maintenance" => "#ffc107",
            "High" => "#dc3545", 
            "Medium" => "#ffc107",
            "Low" => "#28a745", 
            _ => "#00ffff" 
        };
    }

    [JSInvokable]
    public async Task OnLocationClicked(string locationName)
    {
        string industry = DetectIndustry(locationName);
        JsonObject? targetItem = null;

        // Find the data object
        if (industry == "recycler") targetItem = RecyclerData?.FirstOrDefault(d => d["Name"]?.ToString() == locationName);
        else if (industry == "retail") targetItem = RetailData?.FirstOrDefault(d => d["Name"]?.ToString() == locationName);
        else if (industry == "factory") targetItem = FactoryData?.FirstOrDefault(d => d["Name"]?.ToString() == locationName);

        if (targetItem != null)
        {
            // Fetch Schema for rendering
            var schema = await _schemaService.GetSchemaAsync(industry);
            if (schema != null && schema.Entities.Count > 0)
            {
                SelectedDefinition = schema.Entities[0]; // The Top-Level Entity (Location, Store, Line)
                SelectedItems = new JsonArray { targetItem.DeepClone() }; // Wrap in array for renderer, Clone to avoid Parent error
                StateHasChanged();

                // Trigger Camera Fly-To Animation
                double lat = (double?)targetItem["Latitude"] ?? 0;
                double lon = (double?)targetItem["Longitude"] ?? 0;
                await JS.InvokeVoidAsync("universalMap.flyToLocation", lat, lon);
            }
        }
    }

    private async Task ClosePopup()
    {
        SelectedItems = null;
        SelectedDefinition = null;
        await JS.InvokeVoidAsync("universalMap.resetCamera");
    }

    private string DetectIndustry(string name)
    {
        if (name.Contains("MegaMart") || name.Contains("QuickStop")) return "retail";
        if (name.Contains("Plant") || name.Contains("Fab")) return "factory";
        return "recycler"; 
    }

    public void Dispose()
    {
        _objRef?.Dispose();
    }
}
