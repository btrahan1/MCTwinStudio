@page "/polygon-test"
@inject IJSRuntime JS
@inject MCTwin.Shared.Services.PolygonService _polyService
@using MCTwin.Shared.Geometry
@using MCTwin.Shared.Meshing

<div class="row h-100 g-0">
    <div class="col-3 p-3 bg-light border-end overflow-auto">
        <h3>Polygon DNA</h3>
        <p class="text-muted">Procedural Humanoid Generator</p>
        
        <div class="mb-3">
            <label>Muscle Tone (Smoothness)</label>
            <input type="range" class="form-range" min="0.01" max="0.5" step="0.01" @bind="Recipe.MuscleTone" @bind:event="oninput" />
            <small>@Recipe.MuscleTone</small>
        </div>

        <div class="mb-3">
            <label>Torso Width</label>
            <input type="range" class="form-range" min="0.2" max="0.8" step="0.05" @bind="Recipe.TorsoWidth" @bind:event="oninput"  />
        </div>

        <div class="mb-3">
            <label>Shoulder Width</label>
            <input type="range" class="form-range" min="0.3" max="1.0" step="0.05" @bind="Recipe.ShoulderWidth" @bind:event="oninput" />
        </div>
        
        <div class="mb-3">
            <label>Height</label>
            <input type="range" class="form-range" min="1.0" max="2.5" step="0.1" @bind="Recipe.Height" @bind:event="oninput" />
        </div>
        
        <div class="d-grid gap-2">
            <button class="btn btn-primary" @onclick="Generate" disabled="@IsGenerating">
                @if(IsGenerating) { <span class="spinner-border spinner-border-sm"></span> } 
                else { <span>Generate Mesh</span> }
            </button>
        </div>
        
        <div class="mt-3">
            <strong>Stats:</strong>
            <div>Vertices: @VertexCount</div>
            <div>Time: @GenerationTime ms</div>
        </div>
    </div>
    
    <div class="col-9">
         <iframe id="mctwin-renderer" src="renderer/viewer.html" style="width:100%; height:99vh; border:none;"></iframe>
    </div>
</div>

@code {
    private HumanoidRecipe Recipe = new HumanoidRecipe();
    private bool IsGenerating = false;
    private int VertexCount = 0;
    private long GenerationTime = 0;

    private async Task Generate()
    {
        IsGenerating = true;
        StateHasChanged();
        
        var sw = System.Diagnostics.Stopwatch.StartNew();
        
        var mesh = await _polyService.GenerateHumanoidAsync(Recipe);
        
        sw.Stop();
        GenerationTime = sw.ElapsedMilliseconds;
        VertexCount = mesh.Vertices.Count / 3;
        
        // Send to Viewer
        // We need to use the Bridge or direct access if simple
        // Since we are not inside the iframe, we use the bridge approach or simple JS invoke targeting the frame
        // Actually, the simplest way is to call a function on window that the iframe exposes or use the bridge I saw earlier in index.html
        
        // Direct call via MCTwinBridge defined in index.html
        await JS.InvokeVoidAsync("MCTwinBridge.call", "MCTwin.createCustomMesh", mesh.Vertices.ToArray(), mesh.Indices.ToArray(), mesh.Normals.ToArray());

        IsGenerating = false;
        StateHasChanged();
    }
}
